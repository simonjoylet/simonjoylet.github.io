---
layout: post
title: 分布式一致性协议对比
tags:
- 一致性
- Paxos
categories: 分布式
---

一致性问题是分布式系统中的核心问题，目前经典的一致性算法包括2PC、3PC、Paxos、ZAB、Multi-Paxos、Raft、Dynamo等等，本文将对梳理和对比这些算法。

<!--more-->

## CAP理论
　　CAP理论是Eric Brewer在1999年提出，指分布式系统中强一致性（C）、高可用性（A）和分区容错性（P）三者不可能同时满足，该理论于2002年被证明。在目前的网络设施下，分布式系统中的网络分区错误难以避免，因此分区容错性（P）一般必须保证，只能在强一致性（C）和高可用性（A）中进行权衡。
　　然而三选二的理论存在误导性，CAP理论作者本人在2012年重新梳理的CAP理论。其实CAP理论只是说完美的强一致和高可用不能同时和分区容错并存，但是不完美的呢？首先分区不发生的情况下，CA可以共存，而且P发生的概率一般不高，所以没有必要在设计之初直接放弃C或者A。其次，假设分区发生了，C和A的选择一定完全水火不容吗？这也不一定，因为C包括了很多数据，A也包括了很多服务，要具体情况具体分析，而非一刀切。有些数据放弃C是没什么问题的，但有些数据一旦不一致就会造成重大影响。A也一样，有些服务并不会影响C，那完全可以继续提供，有些服务直接影响不能放弃C的数据，这类服务就必须暂时不可用。那放弃了C的部分数据一定就不一致了吗？放弃了A的服务一定就会让客户很不开心吗？这也不一定，例如分区期间暂时放弃了C的数据可以在分区恢复之后进行合并，合并方法又有很多种。放弃了A的服务虽然不能立即给出应答，但可以记录下客户的操作意向，给出进行中的提示。
　　总结来说，CAP理论并非三选二那么简单，因为该理论只是不允许分区错误发生的情况下所有数据都是强一致，所有服务都立即给出正确应答这种完美的系统。所以，即使不能达到完美，但可以努力趋近完美。
## 2PC与3PC
### 2PC
　　两阶段提交时分布式关系型数据库中实现事务的经典方法，都是基于协调者（leader）的事务提交方法。顾名思义，数据的提交分为两个阶段：

1. 第一阶段是prepare阶段，也叫投票阶段。  
　　协调者向参与者发起事务准备请求，参与者执行事务并记录日志，然后向协调者发送Ack消息。如果参与者不能执行事务，则向协调者发送No消息。

2. 第二阶段是commit阶段，也叫执行阶段，这个阶段分为两种情况。  
　　2.1 如果协调者收到所有参与者的ack消息，则协调者向所有参与者发送事务提交请求，参与者提交事务，然后向协调者发送ack消息。
　　2.2 如果任意一个参与者向协调者发送了No消息，则协调者向所有参与者发送事务回滚请求，协调者根据日志回滚事务，然后向协调者发送ack消息。

　　两阶段提交的优点是原理简单，实现方便，但有个很明显的缺点就是同步阻塞问题，如果任意一个参与者挂掉，则事务会阻塞，其他参与者拿到的事务资源也无法释放。另外，2阶段提交还有明显的单点问题、网络异常时的数据不一致问题。

### 3PC
　　三阶段提交是为了解决两阶段提交的同步阻塞问题而提出的，同时改良了（而非解决）两阶段提交的数据不一致问题。三阶段提交分为三个阶段：
- 1. 第一阶段是CanCommit阶段
　　协调者向参与者发起PreCommit请求，询问参与者能否执行事务，如果参与者可以执行事务，则恢复yes消息，否则恢复no消息。
- 2. 第二阶段是PreCommit阶段
　　2.1 如果协调者收到所有参与者的yes消息，则协调者向参与者发送PreCommit请求，参与者执行事务并记录日志，然后向协调者发送ack消息，如果参与者未能执行事务，则向协调者发送no消息。
　　2.2 如果协调者收到任意一个参与者的no消息或者超时没能收到部分参与者的应答，则协调者向参与者发送abort请求，参与者中断事务。
　　2.3 如果参与者超时没能收到协调者的PreCommit请求，则参与者中断事务。
- 3. 第三阶段是DoCommit阶段
　　3.1 如果协调者收到所有参与者第二阶段的ack消息，则协调者向参与者发出DoCommit请求，参与者执行事务提交并释放事务资源，然后向协调者发送ack消息
　　3.2 如果协调者收到任意一个参与者的no消息或者超时没能收到部分参与者的应答，则协调者向参与者发送abort请求，参与者根据日志回滚事务并释放事务资源，然后向协调者发送ack消息。
　　3.3 如果参与者超时没能收到协调者的DoCommit请求，则参与者执行事务提交并释放事务资源。

　　三阶段提交通过设置超时解决了两阶段提交中的同步阻塞问题，通过增加事务询问阶段，提高了某个节点故障之后的数据仍然保持一致的概率，但仍存在某些情况下数据不一致的可能。

## Paxos

## ZAB

## Multi-Paxos

## Raft

## Dynamo

